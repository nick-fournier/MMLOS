---
title: "A not so vigorous vignette for MMLOS usage"
author: "Nick Fournier, PhD"
date: "8/7/2020"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
library(data.table)
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = "../")
```

### R Markdown

This is a vignette going through a simple example use of **MMLOS**, the Multi-Modal Level of Service calculator from the Highway Capacity Manual in *R*.

In this vignette we will go over basic usage of MMLOS for calculating the LOS of links, intersections, and segments for bicycles and pedestrians (automobiles and transit to be implemented in future versions). This includes loading the link and intersection data from CSV and the proper data format of the CSV data. We will also do a bit of plotting the results, and comparing the results from the existing HCM methodology to our proposed revisions.


### Data formatting

Let's begin with with a [description of data](https://github.com/nick-fournier/MMLOS/blob/master/data/input_link_template.csv), shown below. There are two CSV files, one for links and one for segments. Templates can be found at [data/input_intersection_template.csv](https://github.com/nick-fournier/MMLOS/blob/master/data/input_intersection_template.csv) and [data/input_link_template.csv](https://github.com/nick-fournier/MMLOS/blob/master/data/input_link_template.csv).


```{r link description, echo = F} 
dat = fread("./data/input_descriptions.csv")[TYPE == "LINK", .(VAR,DESC)]
dat = setNames(dat, c("Variable","Description"))
kable(dat, caption = "Link data format:")
```

```{r int description, echo = F} 
dat = fread("./data/input_descriptions.csv")[TYPE == "INT", .(VAR,DESC)]
dat = setNames(dat, c("Variable","Description"))
kable(dat, caption = "Intersection data format:")
```

### General Usage

First install (if you haven't already) and load the package:

```{r libload} 
# #Install the MMLOS package (commented out to avoid errors)
# library(devtools)
# install_github("nick-fournier/MMLOS")

#Activate the installed package.
library(MMLOS)
```

After roadway data has been properly formatted into the **link** and **intersection** CSV files, they can be imported to *R*. the **dirs** 

For now we'll just use the template data.

```{r loaddat}
dat <- loaddat("template")
```

We can take a peak at this. Note the NA's in this example are because some intersections are only three-ways, so one approach is missing.

```{r head}
lapply(loaddat("template"),function(x) head(x,8))
```

Now we can calculate the LOS. First lets do it using the existing HCM methodology:
```{r existing}
existing <- calcMMLOS(dat, revs = F)

Revisions <- calcMMLOS(dat, revs = T)


#Display
# Current$bike
# Revisions$bike

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.















#library(MMLOS)
library(data.table)
library(ggplot2)
library(gridExtra)
library(pbapply)
library(extrafont)
library(ggpubr)












#### LOS Analysis of speed vs volume at intersections ####
#Intersections vary speed and volume
int.spdvol <- expand.grid(
  int_id   = NA,
  app_dir  = NA,
  traf_dir = NA,
  N_d      = 1,
  N_th     = 1,
  S_85mj   = seq(5, 50, by = 5), #links$S_f and int$S_85mj
  v_rt     = NA,
  v_lt     = NA,
  v_th     = NA,
  v_v      = seq(50, 1200, by = 50), #Vehicle volume at intersection
  v_rtor   = NA,
  v_ltperm = NA,
  v_p      = 100,
  v_b      = 250,
  v_bl     = 250/4,
  v_br     = 250/4,
  P_bl2    = 0.5,
  N_rtcid  = 0,
  g        = 31.7,
  l        = 3.3,
  C        = 90,
  Walkmi   = 31.7,
  W_c      = 12,
  W_cd     = 24,
  L        = 24,
  W_bl     = 5,
  W_ol     = 12,
  p_pk     = 0.8,
  W_os     = 8,
  M_yp     = 0.5,
  M_yb     = 0.05,
  S_p      = 3.5,
  S_b      = 10,
  t_sb     = 3,
  t_sp     = 3,
  control  = "Signalized",
  curb     = TRUE)

#Calculate subsequent dummy vars
int.spdvol <- as.data.table(int.spdvol)
int.spdvol[ , v_rt := v_v/4]
int.spdvol[ , v_lt := v_v/4]
int.spdvol[ , v_th := v_v/2]
int.spdvol[ , v_rtor := v_v/2]
int.spdvol[ , v_ltperm := v_v/4]
int.spdvol[ , int_id := 1:nrow(int.spdvol)]
int.spdvol <- rbindlist(lapply(c("NB","SB","EB","WB"), function(x) {
  tmp = int.spdvol
  tmp$traf_dir <- rep(x, nrow(int.spdvol))
  tmp$app_dir <- rep(switch(x,
                            "NB" = "S",
                            "SB" = "N",
                            "EB" = "W",
                            "WB" = "E"),
                     nrow(int.spdvol))
  return(tmp)
}))

#Calculate LOS
LOS <- rbindlist(pblapply(unique(int.spdvol$int_id), function(x) {
  int = int.spdvol[int_id == x, ]
  data.table("v_v" = int$v_v[1], "S_85mj" = int$S_85mj[1],
             I_int.rev = bike.I_int(int, "EB"),
             I_int.og = ogbike.I_int(int, "EB"))
}))

#Melt into longform
LOS <- melt(LOS, c("v_v","S_85mj"))

#Score
LOS$LOS <- sapply(LOS$value, MMLOS::score2LOS)


#### #LOS plot ####
plot.LOS = lapply(c("I_int.rev","I_int.og"), function(x) {
  ggplot(data = LOS[variable == x, ], aes(x = v_v, y = S_85mj, z = value)) + 
    # geom_tile() +
    # scale_fill_distiller("LOS", palette = "RdYlGn", limits = range(LOS$value)) +
    geom_contour_filled(breaks = c(-Inf,2.00,2.75,3.50,4.25,5.00,Inf)) +
    scale_fill_manual("LOS score", values = rev(RColorBrewer::brewer.pal(n = 6, name = "RdYlGn")),
                      labels = c("A","B","C","D","E","F")) +
    scale_x_continuous("Automobile traffic volume (veh/hr)", expand = c(0,0)) +
    scale_y_continuous("Automobile traffic speed (mph)", expand = c(0,0)) +
    coord_fixed(ratio = 25) +
    theme_bw() +
    theme(text = element_text(family = "Times New Roman"), legend.position = "bottom", )
})
names(plot.LOS) <- c("rev","og")

ggarrange(plot.LOS$rev, plot.LOS$og, ncol = 2, common.legend = T, legend = "right")
